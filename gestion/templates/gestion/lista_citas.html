{% extends 'gestion/base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between">
        <h2 class="text-primary">Lista de Citas</h2>
        
        <!-- Botón para enviar notificaciones -->
        <button id="enviar-notificaciones" class="btn btn-warning">Enviar Notificaciones</button>
    </div>

    <!-- Aquí es donde mostramos los mensajes -->
    <div id="mensaje-alerta" class="mt-3"></div>

    <div class="table-responsive mt-4">
        <table class="table table-hover table-striped align-middle border rounded">
            <thead class="bg-primary text-white text-center">
                <tr>
                    <th>Paciente</th>
                    <th>Motivo</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Confirmada</th>
                </tr>
            </thead>
            <tbody>
                {% for cita in citas %}
                <tr class="text-center">
                    <td>{{ cita.paciente.nombre }} {{ cita.paciente.apellido }}</td>
                    <td>{{ cita.motivo }}</td>
                    <td>{{ cita.fecha|date:"d/m/Y" }}</td>
                    <td>{{ cita.fecha|time:"H:i" }}</td>
                    <td>
                        {% if cita.confirmada %}
                        <span class="badge bg-success">Sí</span>
                        {% else %}
                        <span class="badge bg-danger">No</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Manejar la solicitud de envío de notificaciones
    document.getElementById('enviar-notificaciones').addEventListener('click', function() {
        fetch("{% url 'enviar_notificaciones' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const mensajeAlerta = document.getElementById('mensaje-alerta');
            if (data.status === 'success') {
                mensajeAlerta.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            } else {
                mensajeAlerta.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }
        })
        .catch(error => {
            console.error('Error al enviar notificaciones:', error);
        });
    });
</script>

{% endblock content %}
